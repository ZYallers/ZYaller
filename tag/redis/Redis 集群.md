[//]:# "2023/4/21 11:18|Redis"

# Redis 集群

> 文章转载自：[cnblog](https://www.cnblogs.com/wugongzi/p/16827473.html)

在生产环境中，我们使用 Redis 通常采用集群模式，因为单机版 Redis 稳定性可靠性较低，而且存储空间有限。

Redis 支持三种集群模式

- 主从复制
- 哨兵模式
- Cluster 模式

## 1. 主从复制

### 1.1 概念

主从复制模式，有一个主，多个从，从而实现读写分离。主机负责写请求，从机负责读请求，减轻主机压力。

![IMG](https://raw.githubusercontent.com/ZYallers/ZYaller/master/upload/image/2023/1058428-20221026103622058-421123069.png)

### 2.2 原理

![IMG](http://raw.githubusercontent.com/ZYallers/ZYaller/master/upload/image/2023/1058428-20221026103622086-371606505.png)

1. 从数据库启动成功后，连接主数据库，发送 SYNC 命令；
2. 主数据库接收到 SYNC 命令后，开始执行 BGSAVE 命令生成 RDB 文件并使用缓冲区记录此后执行的所有写命令；
3. 主数据库 BGSAVE 执行完后，向所有从数据库发送快照文件，并在发送期间继续记录被执行的写命令；
4. 从数据库收到快照文件后丢弃所有旧数据，载入收到的快照；
5. 主数据库快照发送完毕后开始向从数据库发送缓冲区中的写命令；
6. 从数据库完成对快照的载入，开始接收命令请求，并执行来自主数据库缓冲区的写命令；（从数据库初始化完成）
7. 主数据库每执行一个写命令就会向从数据库发送相同的写命令，从数据库接收并执行收到的写命令（从数据库初始化完成后的操作）
8. 出现断开重连后，2.8之后的版本会将断线期间的命令传给重数据库，增量复制。
9. 主从刚刚连接的时候，进行全量同步；全同步结束后，进行增量同步。当然，如果有需要，slave 在任何时候都可以发起全量同步。Redis 的策略是，无论如何，首先会尝试进行增量同步，如不成功，要求从机进行全量同步。

### 2.3 优缺点

#### 2.3.1 优点

1. 支持主从复制，主机会自动将数据同步到从机，可以进行读写分离
2. Slave 同样可以接受其它 Slaves 的连接和同步请求，这样可以有效的分载 Master 的同步压力
3. Master Server 是以非阻塞的方式为 Slaves 提供服务。所以在 Master-Slave 同步期间，客户端仍然可以提交查询或修改请求

#### 2.3.2 缺点

1. 主从不具备容错和恢复能力，一旦主机挂了，那么整个集群处理可读状态，无法处理写请求，会丢失数据
2. 主机宕机后无法自动恢复，只能人工手动恢复
3. 集群存储容量有限，容量上线就是主库的内存的大小，无法存储更多内容

## 2. 哨兵集群

### 2.1 概念

哨兵，我们经常在电视剧中看到一些放哨的，哨兵的作用和这些放哨的差不多，起到监控作用。一旦 Redis 集群出现问题了，哨兵会立即做出相应动作，应对异常情况。

哨兵模式是基于主从复制模式上搭建的，因为主从复制模式情况下主服务器宕机，会导致整个集群不可用，需要人工干预，所以哨兵模式在主从复制模式下引入了哨兵来监控整个集群，哨兵模式架构图如下：

![IMG](https://raw.githubusercontent.com/ZYallers/ZYaller/master/upload/image/2023/1058428-20221026103622394-1740773542.png)

### 2.2 功能

**监控（Monitoring）**：哨兵会不断地检查主节点和从节点是否运作正常。

**自动故障转移（Automatic failover）**：当主节点不能正常工作时，哨兵会开始自动故障转移操作，它会将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点改为复制新的主节点。

**配置提供者（Configuration provider）**：客户端在初始化时，通过连接哨兵来获得当前Redis服务的主节点地址。

**通知（Notification）**：哨兵可以将故障转移的结果发送给客户端。

### 2.3 下线判断

Redis 下线分为主观下线和客观下线两种

1. 主观下线：单台哨兵任务主库处于不可用状态
2. 客观下线：整个哨兵集群半数以上的哨兵都认为主库处于可不用状态

哨兵集群中任意一台服务器判断主库不可用时，此时会发送命令给哨兵集群中的其他服务器确认，其他服务器收到命令后会确认主库的状态，如果不可用，返回 YES，可用则返回 NO，当有半数的服务器都返回 YES，说明主库真的不可用，此时需要重新选举。

![](https://raw.githubusercontent.com/ZYallers/ZYaller/master/upload/image/2023/1058428-20221026103622042-973065006.png)

### 2.4 主库选举

当哨兵集群判定主库下线了，此时需要重新选举出一个新的主库对外提供服务。那么该由哪个哨兵来完成这个新库选举和切换的动作呢？

> 注意：这里不能让每个哨兵都去选举，可能会出现每个哨兵选举出的新主库都不同，这样就没法判定，所以需要派出一个代表。

#### 哨兵代表选择

哨兵的选举机制其实很简单，就是一个Raft选举算法： **选举的票数大于等于num(sentinels)/2+1时，将成为领导者，如果没有超过，继续选举**。

任何一个想成为 Leader 的哨兵，要满足两个条件：

1. 第一，拿到半数以上的赞成票；
2. 第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。

以 3 个哨兵为例，假设此时的 quorum 设置为 2，那么，任何一个想成为 Leader 的哨兵只要拿到 2 张赞成票，就可以了。

#### 新主库选择

上面已经选举出了哨兵代表，此时代表需要完成新主库的选择，新库的选择需要满足以下几个标准

1. 新库需要处于健康状态，也就是和哨兵之间保持正常的网络连接
2. 选择`salve-priority`从节点优先级最高（redis.conf）的
3. 选择复制偏移量最大，只复制最完整的从节点

### 2.5 故障转移

上面一小节哨兵已经选举出了新的主库，故障转移要实现新老主库之间的切换

故障转移流程如下：

![](https://raw.githubusercontent.com/ZYallers/ZYaller/master/upload/image/2023/1058428-20221026103623054-392611224.png)

### 2.6 优缺点

#### 优点

1. 实现了集群的监控，故障转移，实现了高可用
2. 拥有主从复制模式的所有优点

#### 缺点

1. 集群存储容量有限，容量上线就是主库的内存的大小，无法存储更多内容

## 3. Cluster 集群

Redis 的哨兵模式实现了高可用了，但是每台 Redis 服务器上存储的都是相同的数据，浪费内存，而且很难实现容量上的扩展。所以在 **Redis3.0**上加入了 Cluster 集群模式，实现了 Redis 的分布式存储，**也就是说每台 Redis 节点上存储不同的内容**。

#### Redis 集群的数据分片

Redis 集群没有使用一致性hash，而是引入了**哈希槽**的概念.

Redis 集群有**16384**个哈希槽，每个key通过**CRC16校验**后对16384取模来决定放置哪个槽，集群的每个节点负责一部分hash槽，举个例子比如当前集群有3个节点：

- 节点 A 包含 0 到 5500号哈希槽.
- 节点 B 包含5501 到 11000 号哈希槽.
- 节点 C 包含11001 到 16384号哈希槽.

这种结构很容易添加或者删除节点。比如如果我想新添加个节点D, 我需要从节点 A, B, C中得部分槽到D上，如果我想移除节点A，需要将A中的槽移到B和C节点上，然后将没有任何槽的A节点从集群中移除即可。由于从一个节点将哈希槽移动到另一个节点并不会停止服务，所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态。
