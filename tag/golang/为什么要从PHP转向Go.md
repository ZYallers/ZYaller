# 为什么要从PHP转向Go

## 前言

近来，知乎上讨论着这样一个比较热的话题
> 如何看待大量PHP程序员转向Go语言？

首先说明下，自己之前一直也有从事PHP几年开发的经验，现在也有用Go做项目。

我想说明一下：
1. "大量"是怎么定义，就我自己所在的公司和朋友公司，包括腾讯、头条等大公司还有很多PHP开发的项目。
小公司更不用说了，PHP开发成本更低。
2. 转Go语言，有一定经验的程序员，换一个语言写一下也没太大问题。我们的项目组里大家都是PHP，Python，Go，Shell都会写。
Web前端也会拿一些脚手架来做小玩具。
3. PHP生态越来越好了，如果你要说性能问题，我想说我在的公司都是高并发、大流量的，我用PHP做过不少项目，也可以提供非常稳定的服务。
4. 如果是新手问这个问题我觉得理解。如果是老手那就非蠢既坏。

![K8S集群部署](http://ww1.sinaimg.cn/mw690/77461dbdgy1g9tywuj0yjj20re0lkwrg.jpg)

在最初的时候，我们认为应该使用自己熟悉的编程语言，因为我们是一个小团队，
而且已经做了两项冒险的举动：将我们的大流量平台切换到微服务和完全重建Web应用程序。

不过，最终，我们还是决定PHP转向Go。
在这篇文章中，我们将解释为什么要这样做。我们还将分享一些微服务架构中有关数据库的观点。

## 微服务和PHP：错误的搭配
我们熟悉的语言是PHP，它驱动着我们现有的应用程序，有两个模糊的理由支撑着我们使用PHP：
- `我们熟悉PHP和它的怪特性`，而且原来的程序运行得很好，我们为什么要放弃？
- `外面有很多的PHP开发人员`，PHP可以让我们的团队更容易地成长起来。

这些听起来都很正确，但是当我们清楚地认识到PHP真的不是我们这个案例的正确选择时，我们很快就放弃了这些想法。

我们正在向着微服务架构迁移，因为我们希望这些大流量的基础架构具备可扩展性。
从长远来看，随着我们向500万甚至更多用户发展的时候，我们的基础设施也应该能相应地进行扩大。

PHP无法满足这些需求，因为：

- `PHP的启动成本很高` 
PHP一开始是为`短生命周期`脚本的运行而设计的，因此`持久性`并不是其原生特性。
这意味着对于每个请求、数据库连接和类都必须实例化，这增加了不必要的开销。
当然，这也是有办法解决的，例如通过`PHP-FPM`或`Apache`来创建连接池，或者绑定C以获得与Redis的长连接。
但是，由于我们需要追求高性能，所以这些依赖让我们开始质疑PHP对于这个系统来说是否是一个合适的工具。

- `容器化的PHP是一个雷区`
PHP需要借助`Nginx`和`PHP-FPM`（或类似的软件）来进行进程管理和连接池管理。
这意味着对于部署的每个微服务来说，PHP-FPM和Nginx必须同时运行。
这既浪费了资源，又降低了效率。对运行在服务器上的PHP实例进行优化也是相当困难的，因为你需要同时熟悉PHP、PHP-FPM和Nginx的配置。
我们无法想象在弹性`Kubernetes`环境上配置多个PHP栈的痛苦，我们甚至不知道在这同一台机器上还运行了其他什么东西。

对微服务来说，其复杂性存在于架构中，因为你正在处理的是一个复杂的交互系统。
既然我们已经确定采用微服务架构，那么因为错误的选择了编程语言导致的消耗显然就不值得。

## 拥抱Go

> 那么为什么要使用Go呢？

- `性能`
Go的二进制文件会生成一个长时间运行的进程，这意味着每个请求和数据库连接的启动成本很低。
这使得Go在处理大量的并发请求时能保证极快的速度，因为Go语言（goroutines模块）专为网络和多核计算而设计。

- `Go可以编译出一个小巧便携的二进制文件`
这使得Go非常适合在Docker容器中使用。部署我们的Go容器只需几秒钟，因为它们的体积很小（大多数是4-5MB），
并且由于是静态链接，因此在容器内不需要OS或运行时依赖。
例如，当使用`Node Alpine Linux`镜像时，我们的前端容器大约为`55MB`。而PHP-FPM镜像容器大约为`700MB`。

- `Go是类型严格的`
这让代码中的内部通信更为可靠，也有助于在构建期间捕获异常，而不是在运行期间。

Go的工具链的规模很大。虽然工具是很多编程语言关注的问题，但Google从一开始就解决了这个问题，
他提供了大量常用的工具作为语言安装时的一部分。

我们也考虑到Go有这些缺点：

- Go不附带依赖管理器。(1.11版本之后，Google官方出了GoModule依赖包管理工具，类似PHP的Composer。)
- 太多的公式化代码。这是Go优雅和简单的另一面。

然而，我们必须接受这一点：用Go程序确实需要花上一些功夫，但它能提高代码质量，并让我们能够时刻知道代码实际是如何运行的。

这并不是说所有的代码我们都用Go来写。对于服务器端渲染，我们使用PHP或`Node`，因为它允许我们在前端和后端之间共用代码逻辑。
我们也可以使用`Java`来解决特定的问题，因为它已经存在了很长时间，并且拥有大量的库。
我们希望能使用最合适的工具，对于大多数情况而言，Go是我们的首选。


## 开发比较
看看PHP和Golang如何在开发速度，性能，安全性，可伸缩性等方面展开合作。

PHP最初创建于1994年，已有25年。自那时起，由于PHP的开源格式，易用性和稳定性，PHP的知名度不断提高。然而，正如生活中的其他方面所发生的那样，如果老人不能适应现代，老人必须为新生物让路。即使是最新版本的PHP，比如PHP 7，在安全性，可伸缩性，并发性等方面也有很多不足之处。随着时代的变迁，应用程序的需求也在不断变化。快速部署，并发，可扩展，无缺陷，低维护和经济高效的应用是当今的需求。

- `性能`

Golang和PHP的表现速度差异很大。Kairos报告说，当客户从PHP构建转移到Golang时，其客户报告API事务速度提高了8倍。
发生这种情况是因为Golang比PHP更有效地处理数据处理。此外，由于编译方面的原因，即使是糟糕的Golang代码也会优于良好的PHP代码，从而提高性能。更重要的是，最终用户可以获得快速执行的应用程序。

- `上线时间`

快速上线必须是Golang最经常重复的优势。PHP需要编写几乎五倍的代码才能生成与Golang应用程序相同的功能。
想象一下，为应用程序部署而节省的时间。通过让企业应用程序及时运行，企业可以节省宝贵的时间。

- `成本`

由于多线程技术提高了Golang的效率，减少了部署规模，减少了内存占用量，并且整体运行的Docker容器减少了，
所以团队可以将Kubernetes集群中的主机数量减少50％以上。Go部署需要的容器数量惊人地少于处理比PHP API高得多的负载。
鉴于这些因素，Golang降低了企业的间接成本。

- `安全`

由于Golang内置的错误检查机制，由于开发人员疏忽而出现漏洞的可能性非常低。
Golang对编译进行分析，并通知开发人员错误，并在推向产品之前让他们解决。这导致更安全的代码。
相比之下，由于PHP超文本预处理器的开源特性，每个人都可以查看PHP的源代码。
因此，黑客有可能识别代码中的错误，并随后使用这些错误攻击不知情的用户。

- `可扩展`

使用PHP编程巨大的应用程序很困难。PHP不能有效地支持独立的可互换模块，因此在PHP中开发庞大的应用程序对开发人员来说是一场噩梦。
PHP最初是为了创建动态网站而开发的，而不是针对Windows和其他操作系统桌面应用程序。
这可能是它不支持大量应用程序的原因。另一方面，Golang是一种更现代化的语言。它几乎比任何其他语言都支持更多的请求。
因此，Golang是最具扩展性的语言。它将随着您的业务增长而增长，以适应您应用程序日益增长的负载。

考虑到上述所有因素，可以肯定地说，企业从PHP迁移到Go是明智之举。

